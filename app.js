// يعمل حتى مع فتح الملف مباشرة (file://) لأن البيانات مضمّنة هنا
const MANIFEST = {"presentations": [{"id": "2-svt-t-che-2-p-riode-2-1ac", "title": "2-SVT - Tâche -2-Période-2-1AC", "folder": "assets/2-SVT-Tâche-2-Période-2-1AC", "slides": ["assets/2-SVT-Tâche-2-Période-2-1AC/slide-01.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-02.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-03.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-04.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-05.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-06.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-07.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-08.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-09.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-10.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-11.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-12.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-13.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-14.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-15.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-16.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-17.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-18.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-19.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-20.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-21.png", "assets/2-SVT-Tâche-2-Période-2-1AC/slide-22.png"]}, {"id": "3-svt-ta-che-3-p-riode-2-1ac", "title": "3-SVT - Tâche -3 -Période-2-1AC", "folder": "assets/3-SVT-Tâche-3 -Période-2-1AC", "slides": ["assets/3-SVT-Tâche-3 -Période-2-1AC/slide-01.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-02.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-03.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-04.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-05.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-06.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-07.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-08.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-09.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-10.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-11.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-12.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-13.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-14.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-15.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-16.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-17.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-18.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-19.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-20.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-21.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-22.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-23.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-24.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-25.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-26.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-27.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-28.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-29.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-30.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-31.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-32.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-33.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-34.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-35.png", "assets/3-SVT-Tâche-3 -Période-2-1AC/slide-36.png"]}, {"id": "4-svt-ta-che-4-p-riode-2-1ac", "title": "4-SVT - Tâche -4 -Période-2-1AC", "folder": "assets/4-SVT-Tâche-4 -Période-2-1AC", "slides": ["assets/4-SVT-Tâche-4 -Période-2-1AC/slide-01.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-02.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-03.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-04.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-05.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-06.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-07.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-08.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-09.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-10.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-11.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-12.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-13.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-14.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-15.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-16.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-17.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-18.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-19.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-20.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-21.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-22.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-23.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-24.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-25.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-26.png", "assets/4-SVT-Tâche-4 -Période-2-1AC/slide-27.png"]}]};

async function loadManifest(){
  return MANIFEST;
}

function icon(name){
  if(name === 'play') {
    return `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 5v14l12-7-12-7z" fill="currentColor"></path>
    </svg>`;
  }
  if(name === 'microscope') {
    return `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 3h4v4H8V3zm7 18H6a4 4 0 0 1 0-8h1v2H6a2 2 0 0 0 0 4h9a3 3 0 0 0 0-6h-1V9h1a5 5 0 0 1 0 10z" fill="currentColor" opacity=".9"/>
      <path d="M10 7l5 5-2 2-5-5V7h2z" fill="currentColor" opacity=".45"/>
    </svg>`;
  }
  if(name === 'tooth') {
    return `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2c-3.5 0-6 2-6 5.5 0 4.2 2.2 12.5 4.5 12.5 1.2 0 1.3-2.2 1.5-3.6.2-1.2.4-2.4 0-3.4.8 0 1 .9 1.2 2.1.3 1.8.2 4.9 1.8 4.9C18.8 20 20 11.6 20 7.5 20 4 17.5 2 12 2z" fill="currentColor" opacity=".85"/>
    </svg>`;
  }
  return '';
}

function pickDecor(p){
  const t = p.title.toLowerCase();
  if(t.includes('tâche -3') || t.includes('tâche-3')) return {ico:'microscope', label:'مشاهدة بالمجهر'};
  if(t.includes('tâche -2') || t.includes('tâche-2')) return {ico:'tooth', label:'الدنتة والنظام الغذائي'};
  if(t.includes('tâche -4') || t.includes('tâche-4')) return {ico:'microscope', label:'خلية / مجهر'};
  return {ico:'play', label:'عرض'};
}

function qs(name){
  return new URLSearchParams(location.search).get(name);
}

async function renderIndex(){
  const data = await loadManifest();
  const cards = document.getElementById('cards');
  if(!cards) return;

  data.presentations.forEach(p=>{
    const decor = pickDecor(p);
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="row">
        <div class="badge">${decor.label}</div>
        <div class="badge">${p.slides.length} شريحة</div>
      </div>
      <h3>${p.title}</h3>
      <p>نسخة HTML مع تنقّل بين الشرائح + صور مصغّرة.</p>
      <div class="row">
        <a class="btn" href="viewer.html?id=${encodeURIComponent(p.id)}">
          ${icon('play')}
          فتح العرض
        </a>
        <span class="badge" title="تم توليد واجهة HTML/CSS/JS تلقائيًا">HTML • CSS • JS</span>
      </div>
    `;
    cards.appendChild(card);
  });
}

async function renderViewer(){
  const viewerTitle = document.getElementById('viewerTitle');
  const slideImg = document.getElementById('slideImg');
  const caption = document.getElementById('caption');
  const thumbs = document.getElementById('thumbs');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if(!viewerTitle || !slideImg || !thumbs || !prevBtn || !nextBtn) return;

  const id = qs('id');
  const data = await loadManifest();
  const p = data.presentations.find(x=>x.id === id) || data.presentations[0];

  viewerTitle.textContent = p.title;

  let idx = Math.max(0, Math.min(p.slides.length-1, Number(qs('s')||0)));

  function setSlide(i){
    idx = i;
    slideImg.src = p.slides[idx];
    caption.textContent = `الشريحة ${idx+1} / ${p.slides.length}`;
    prevBtn.disabled = idx === 0;
    nextBtn.disabled = idx === p.slides.length-1;

    [...thumbs.querySelectorAll('.thumb')].forEach((el, k)=>{
      el.classList.toggle('active', k === idx);
    });

    const url = new URL(location.href);
    url.searchParams.set('id', p.id);
    url.searchParams.set('s', String(idx));
    history.replaceState({}, '', url);
  }

  p.slides.forEach((src, i)=>{
    const t = document.createElement('button');
    t.className = 'thumb';
    t.type = 'button';
    t.title = `شريحة ${i+1}`;
    t.innerHTML = `<img loading="lazy" src="${src}" alt="مصغّرة ${i+1}">`;
    t.addEventListener('click', ()=>setSlide(i));
    thumbs.appendChild(t);
  });

  prevBtn.addEventListener('click', ()=> setSlide(Math.max(0, idx-1)));
  nextBtn.addEventListener('click', ()=> setSlide(Math.min(p.slides.length-1, idx+1)));

  window.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowLeft') nextBtn.click();
    if(e.key === 'ArrowRight') prevBtn.click();
  });

  setSlide(idx);
}

renderIndex().catch(()=>{});
renderViewer().catch(()=>{});
